--[[
	AnimationSystem.lua
]]--

return function(InfinityECS)
	-- // Services
	local SettingsService = InfinityECS:GetService("Settings", true)
	local ActionService = InfinityECS:GetService("Action", true)

	local CharacterService = InfinityECS:GetService("Character", true)

	-- // Variables
	local AnimationSystem = InfinityECS.System.new()

	local TableFind = table.find	
	local StringMatch = string.match

	function AnimationSystem.OnCharacterAdded(PlayerEntity)
		local Player = PlayerEntity.Player:Get()
		local Janitors = PlayerEntity.Janitors:Get()

		local Humanoid = CharacterService.Humanoid(Player)
		local Animator = Humanoid:WaitForChild("Animator")

		local Janitor = InfinityECS.Janitor.new()
		table.insert(Janitors.Character, Janitor)

		Janitor:Give(Animator.AnimationPlayed:Connect(function(AnimationTrack)
			local Animation = AnimationTrack.Animation
			local AnimationId = StringMatch(Animation.AnimationId, "%d+")
			
			if TableFind(SettingsService.Exploits.Animation.Blacklist, AnimationId) then
				ActionService.TakeAction(Player, SettingsService.Violations.AnimationViolation)
				
				return Player:LoadCharacter()
			end
		end))
	end

	function AnimationSystem:OnPlayerLoaded(PlayerEntity)
		local Player = PlayerEntity.Player:Get()
		local Janitors = PlayerEntity.Janitors:Get()

		local Janitor = InfinityECS.Janitor.new()
		table.insert(Janitors.Global, Janitor)

		Janitor:Give(Player.CharacterAdded:Connect(function()
			AnimationSystem.OnCharacterAdded(PlayerEntity)
		end))
	end

	-- // Binds
	InfinityECS.World:AddSystems(AnimationSystem)
end